<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Order - NAM Coffee</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background-color: #fdfcfb;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar {
      background: linear-gradient(90deg, #4e342e, #6d4c41);
    }
    .navbar-brand {
      font-weight: 700;
      font-size: 1.3rem;
    }
    .nav-link {
      color: #fff !important;
      transition: color 0.2s ease-in-out;
    }
    .nav-link:hover {
      color: #ffcc80 !important;
    }
    .product-card {
      border: 1px solid #eee;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: #fff;
      transition: 0.3s;
    }
    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
    }
    .product-image {
      width: 65px;
      height: 65px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 12px;
    }
    .order-item {
      border-bottom: 1px dashed #ccc;
      padding: 10px 0;
    }
    #discount-select option[disabled] {
      color: #aaa;
      font-style: italic;
    }
    .card {
      border-radius: 15px;
      border: none;
      box-shadow: 0px 6px 15px rgba(0,0,0,0.08);
    }
    .favorite-badge {
  position: absolute;
  top: 5px;
  right: 5px;
  background: gold;
  color: #fff;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.product-card.favorite {
  background: #fff8dc; /* nh·∫°t v√†ng */
  position: relative;
}
#notif-badge {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">‚òï NAM Cohhee</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav fw-semibold">
        <li class="nav-item"><a class="nav-link" href="/index">Trang ch·ªß</a></li>
        <li class="nav-item"><a class="nav-link" href="/menu">Th·ª±c ƒë∆°n</a></li>
        <li class="nav-item"><a class="nav-link" href="/blog">Blog</a></li>
        <li class="nav-item"><a class="nav-link" href="/contact">Li√™n h·ªá</a></li>
        <li class="nav-item"><a class="nav-link" href="/order">Order</a></li>
        <li class="nav-item">
          <a class="nav-link active position-relative" href="/notifications">
            <i class="fa fa-bell position-relative">
              <span id="notif-badge"
                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle {% if unread_count == 0 %}d-none{% endif %}">
              </span>
            </i>
          </a>
        </li>
        {% if session.get('username') %}
          <li class="nav-item"><a class="nav-link" href="/account">üëã Xin ch√†o, {{ session.get('username') }}</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('log_out') }}">ƒêƒÉng xu·∫•t</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">ƒêƒÉng nh·∫≠p</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- N·ªôi dung ch√≠nh -->
<div class="container mt-4">
  <div class="row">
    <!-- Danh s√°ch s·∫£n ph·∫©m y√™u th√≠ch -->
    <div class="col-md-3">
      <h4 class="mb-3 text-brown">üåü Y√™u th√≠ch</h4>
      <div id="favorites-products">
        {% for p in favorites_list %}
          <div class="product-card d-flex align-items-center favorite">
            <img src="{{ p.image_url }}" alt="·∫¢nh s·∫£n ph·∫©m" class="product-image">
            <div class="flex-grow-1">
              <strong>{{ p.name }}</strong><br>
              <small>Gi√°: {{ "{:,.0f}".format(p.price) }} USD</small>
            </div>
            <button class="btn btn-sm btn-success ms-2" onclick="addToOrder('{{ p.name }}',{{p.price}})">
              <i class="fa fa-plus"></i>
            </button>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Danh s√°ch s·∫£n ph·∫©m c√≤n l·∫°i -->
    <div class="col-md-5">
      <h4 class="mb-3 text-brown">S·∫£n ph·∫©m</h4>
      <div id="products">
        {% for p in products %}
          <div class="product-card d-flex align-items-center">
            <img src="{{ p.image_url }}" alt="·∫¢nh s·∫£n ph·∫©m" class="product-image">
            <div class="flex-grow-1">
              <strong>{{ p.name }}</strong><br>
              <small>Gi√°: {{ "{:,.0f}".format(p.price) }} USD</small>
            </div>
            <button class="btn btn-sm btn-success ms-2" onclick="addToOrder('{{ p.name }}',{{p.price}})">
              <i class="fa fa-plus"></i>
            </button>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- ƒê∆°n h√†ng / h√≥a ƒë∆°n -->
    <div class="col-md-4">
      <h4 class="mb-3">ƒê∆°n h√†ng c·ªßa b·∫°n</h4>
      <div class="card p-3">
        <div id="order-container">
          <p class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong ƒë∆°n h√†ng.</p>
        </div>

        <!-- M√£ gi·∫£m gi√° -->
        <div class="mt-3">
          <label for="discount-select" class="form-label">üéüÔ∏è Ch·ªçn m√£ gi·∫£m gi√°:</label>
          <select class="form-select" id="discount-select" onchange="applyDiscount()">
            <option value="0" selected>Kh√¥ng √°p d·ª•ng</option>
            {% for d in discounts %}
              <option value="{{ d.id }}" data-discount="{{ d.discount }}" {% if d.expired %}disabled{% endif %}>
                {% if d.expired %}
                  ‚ùå {{ d.code }} - H·∫øt h·∫°n ng√†y {{ d.expiry_date.strftime("%d/%m/%Y") }}
                {% else %}
                  üí∏ {{ d.code }} - Gi·∫£m {{ d.discount }} USD | HSD: {{ d.expiry_date.strftime("%d/%m/%Y") }}
                {% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
        <div class="mt-3">
          <label for="destination" class="form-label">üìç ƒê·ªãa ch·ªâ giao h√†ng</label>
          <input type="text" class="form-control" id="destination" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ c·ªßa b·∫°n">
        </div>

        <!-- Ghi ch√∫ -->
        <div class="mt-3">
          <label for="note" class="form-label">üìù Ghi ch√∫ ƒë∆°n h√†ng</label>
          <textarea class="form-control" id="note" rows="2" placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."></textarea>
        </div>

        <!-- T·ªïng ti·ªÅn -->
        <div class="mt-3 border-top pt-3">
          <strong>T·∫°m t√≠nh: <span id="subtotal-price">0</span> USD</strong><br>
          <strong>Gi·∫£m gi√°: <span id="discount-amount">0</span> USD</strong><br>
          <strong>T·ªïng c·ªông: <span id="total-price">0</span> USD</strong>
        </div>

        <div class="mt-3 text-end">
          <button class="btn btn-primary" onclick="submitOrder()">‚úÖ X√°c nh·∫≠n ƒë∆°n h√†ng</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Gi·ªØ nguy√™n script x·ª≠ l√Ω order -->
<script>
    let order = [];
    let discountValue = 0;

    function addToOrder(name, price) {
      const existing = order.find(item => item.name === name);
      if (existing) {
        existing.quantity += 1;
      } else {
        order.push({ name, price, quantity: 1 });
      }
      renderOrder();
    }

    function removeItem(name) {
      order = order.filter(item => item.name !== name);
      renderOrder();
    }

    function changeQuantity(name, delta) {
      const item = order.find(p => p.name === name);
      if (!item) return;
      item.quantity += delta;
      if (item.quantity <= 0) {
        removeItem(name);
      } else {
        renderOrder();
      }
    }

    function applyDiscount() {
    const select = document.getElementById("discount-select");
    const selectedOption = select.options[select.selectedIndex];
    discountValue = parseFloat(selectedOption.dataset.discount || 0);
    renderOrder();
    }

    function renderOrder() {
      const container = document.getElementById("order-container");
      container.innerHTML = "";

      if (order.length === 0) {
        container.innerHTML = `<p class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong ƒë∆°n h√†ng.</p>`;
        document.getElementById("subtotal-price").innerText = "0";
        document.getElementById("discount-amount").innerText = "0";
        document.getElementById("total-price").innerText = "0";
        return;
      }

      let subtotal = 0;
      order.forEach(item => {
        subtotal += item.price * item.quantity;
        const div = document.createElement("div");
        div.className = "order-item d-flex justify-content-between align-items-center";
        div.innerHTML = `
          <div>
            <strong>${item.name}</strong> x ${item.quantity}<br>
            <small>$${(item.price * item.quantity).toFixed(2)}</small>
          </div>
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="changeQuantity('${item.name}', -1)">-</button>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="changeQuantity('${item.name}', 1)">+</button>
            <button class="btn btn-sm btn-danger" onclick="removeItem('${item.name}')">Remove</button>
          </div>
        `;
        container.appendChild(div);
      });

      const finalTotal = Math.max(subtotal - discountValue, 0);
      document.getElementById("subtotal-price").innerText = subtotal.toFixed(2);
      document.getElementById("discount-amount").innerText = discountValue.toFixed(2);
      document.getElementById("total-price").innerText = finalTotal.toFixed(2);
    }
  function submitOrder() {
    const selectedDiscount = document.getElementById("discount-select").value;
    const destinationValue = document.getElementById("destination").value;
    const noteValue = document.getElementById("note").value;
    const orderData = {
        items: order,
        discount: selectedDiscount,
        destination: destinationValue,
        note: noteValue
    };

    fetch("/submit_order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = "/invoice/" + data.order_id;
      } else {
        alert(data.message || "C√≥ l·ªói x·∫£y ra.");
      }
    })
    .catch(error => {
      console.error("L·ªói khi g·ª≠i ƒë∆°n h√†ng:", error);
      alert("Kh√¥ng th·ªÉ g·ª≠i ƒë∆°n h√†ng.");
    });
  }
</script>
</body>
</html>

