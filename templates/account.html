<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Th√¥ng tin t√†i kho·∫£n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f3e5ab;
    }
    .card {
      background-color: #fff8f0;
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #6f4e37;
    }
    .section-title {
      border-bottom: 2px solid #bfa27a;
      margin-bottom: 10px;
      padding-bottom: 5px;
      color: #6f4e37;
    }
    .table thead {
      background-color: #d2b48c;
      color: #3e2c23;
    }
    .list-group-item {
      background-color: #f8f1e4;
      border: 1px solid #dec7a3;
    }
    .btn-secondary {
      background-color: #6f4e37;
      border: none;
    }
    .btn-secondary:hover {
      background-color: #5a3e2b;
    }
     /* Navbar */
    .navbar {
      background: linear-gradient(90deg, #4e342e, #6d4c41);
    }
    .navbar-brand {
      font-weight: 700;
      font-size: 1.3rem;
    }
    .nav-link {
      color: #fff !important;
      transition: color 0.2s ease-in-out;
    }
    .nav-link:hover {
      color: #ffcc80 !important;
    }
    footer {
      background-color: #4e342e;
      color: #fff;
    }
    footer p {
      margin: 0;
    }
    #notif-badge {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">‚òï NAM Cohhee</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav fw-semibold">
        <li class="nav-item"><a class="nav-link" href="/index">Trang ch·ªß</a></li>
        <li class="nav-item"><a class="nav-link" href="/menu">Th·ª±c ƒë∆°n</a></li>
        <li class="nav-item"><a class="nav-link" href="/blog">Blog</a></li>
        <li class="nav-item"><a class="nav-link" href="/contact">Li√™n h·ªá</a></li>
        <li class="nav-item"><a class="nav-link" href="/order">Order</a></li>
        <li class="nav-item">
          <a class="nav-link active position-relative" href="/notifications">
            <i class="fa fa-bell position-relative">
              <span id="notif-badge"
                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle {% if unread_count == 0 %}d-none{% endif %}">
              </span>
            </i>
          </a>
        </li>
        {% if session.get('username') %}
          <li class="nav-item"><a class="nav-link" href="/account">üëã Xin ch√†o, {{ session.get('username') }}</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('log_out') }}">ƒêƒÉng xu·∫•t</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">ƒêƒÉng nh·∫≠p</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>
  <div class="container mt-5">
    <div class="card p-4">
      <div class="row align-items-center">
        <div class="col-md-3 text-center">
  <img src="{{ customer[4] or url_for('static', filename='images/avatar_default.jpg') }}" alt="Avatar" class="avatar mb-3" id="avatar-img">
  <h5 class="mt-2 text-uppercase" style="color: #6f4e37;">{{ customer[0] }}</h5>
  <form method="POST" enctype="multipart/form-data" id="avatar-form">
    <input type="file" name="avatar" id="avatar-input" accept="image/*" style="display:none;">
    <button type="button" class="btn btn-sm btn-secondary" onclick="document.getElementById('avatar-input').click();">Thay avatar</button>
  </form>
</div>
        <div class="col-md-9">
          <h4 class="section-title">Th√¥ng tin c√° nh√¢n</h4>
          <ul class="list-unstyled">
            <li><strong>T√™n:</strong> <span id="username-text">{{ customer[0] }}</span></li>
            <li><strong>Email:</strong> {{ customer[1] }}</li>
            <li><strong>SƒêT:</strong> <span id="phone-text">{{ customer[2] }}</span></li>
          <li><strong>ƒê·ªãa ch·ªâ:</strong> <span id="address-text">{{ customer[3] }}</span></li>
              </ul>
            <button class="btn btn-sm btn-secondary" id="edit-info-btn">‚úèÔ∏è S·ª≠a th√¥ng tin</button>
          <h5 class="mt-3 text-success">‚òï T·ªïng ti·ªÅn ƒë√£ chi: {{ "{:,.2f}".format(total_spent) }} USD</h5>
        </div>
      </div>
      <hr class="my-4">
      <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <strong>S·∫£n ph·∫©m y√™u th√≠ch</strong>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Lo·∫°i s·∫£n ph·∫©m</th>
                        <th>Gi√° ti·ªÅn</th>
                        <th>ƒê√°nh gi√°</th>
                        <th>S·ªë l·∫ßn mua</th>                        
                    </tr>
                </thead>
                <tbody>
    {% for p in favor_product %}
    <tr>
        <td>{{ p[0] }}</td>
        <td>{{ p[1] }}</td>
        <td>{{ p[2] }}</td>
        <td>{{ p[3] }}</td>
        <td>{{ p[4] }}</td>
    </tr>
    {% else %}
    <tr>
        <td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m y√™u th√≠ch n√†o</td>
    </tr>
    {% endfor %}
</tbody>

            </table>
        </div>
    </div>
      <hr class="my-4">
      <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <strong>ƒê∆°n h√†ng ƒëang x·ª≠ l√Ω</strong>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>M√£ ƒë∆°n</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>S·∫£n ph·∫©m</th>
                        <th> ƒê·ªãa ch·ªâ </th>
                        <th> Note </th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody>
    {% for order in pending_orders %}
    <tr>
        <td>{{ order[0] }}</td>
        <td>{{ order[1] }}</td>
        <td>{{ order[2] }}</td>
        <td>
  {% if order[3] == 'Pending' %}
    <span class="badge bg-warning text-dark">Pending</span>
  {% elif order[3] == 'Processing' %}
    <span class="badge bg-primary">Processing</span>
  {% elif order[3] == 'Delivered' %}
    <span class="badge bg-success">Delivered</span>
  {% else %}
    <span>{{ order[3] }}</span>
  {% endif %}
</td>

        <td>{{ order[4] }}</td>
        <td>{{ order[5] }}</td>
        <td>{{ order[6] }}</td>
        <td>{{ "{:,.2f}".format(order[7]) }}USD</td>
        <td>
            {% if order[3] == 'Delivered' %}
    <form action="{{ url_for('confirm_received', order_id=order[0]) }}" method="post" class="mt-2">
      <button type="submit" class="btn btn-sm btn-success w-100">Nh·∫≠n h√†ng</button>
    </form>
  {% endif %}
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td>
    </tr>
    {% endfor %}
</tbody>

            </table>
        </div>
    </div>
      <h4 class="section-title">L·ªãch s·ª≠ ƒë∆°n h√†ng</h4>
      {% if orders %}
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>M√£ ƒë∆°n</th>
              <th>Ng√†y ƒë·∫∑t</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th> ƒê·ªãa ch·ªâ </th>
              <th>T·ªïng ti·ªÅn</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr>
              <td>{{ order[0] }}</td>
              <td>{{ order[1].strftime('%d/%m/%Y %H:%M') }}</td>
              <td>{{ order[2] }}</td>
              <td>{{ order[3] }}</td>
              <td>{{ "{:,.2f}".format(order[4]) }} USD</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
      {% endif %}
      <h4 class="section-title mt-5">Bi·ªÉu ƒë·ªì ti√™u d√πng 3 th√°ng g·∫ßn nh·∫•t</h4>
      <canvas id="spendingChart" height="100"></canvas>
      <script>
        const maxY = {{ maxY }};
        const ctx = document.getElementById('spendingChart').getContext('2d');
        const spendingChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: {{ labels|tojson }},
            datasets: [{
              label: 'T·ªïng chi ti√™u (USD)',
              data: {{ values|tojson }},
              backgroundColor: ['#a47148', '#c29f79', '#6f4e37'],
              borderRadius: 10
            }]
          },
          options: {
            responsive: true,
            animation: {
              duration: 1000,
              easing: 'easeOutQuart'
            },
            plugins: {
              legend: {
                labels: {
                  color: '#6f4e37',
                  font: {
                    weight: 'bold'
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: { color: '#6f4e37' }
              },
              y: {
                beginAtZero: true,
                max: {{ maxY }},
                ticks: {
                  stepSize: 10,
                  maxTicksLimit: 10,
                  color: '#6f4e37',
                  callback: function(value) {
                    return value + ' USD';
                  }
                },
                title: {
                  display: true,
                  text: 'USD',
                  color: '#6f4e37'
                }
              }
            }
          }
        });
      </script>

      <h4 class="section-title mt-4">Top s·∫£n ph·∫©m ƒë·∫∑t nhi·ªÅu nh·∫•t</h4>
      {% if top_products %}
      <ol class="list-group list-group-numbered">
        {% for item in top_products %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ item[0] }}
          <span class="badge bg-warning text-dark rounded-pill">{{ item[1] }} l·∫ßn</span>
        </li>
        {% endfor %}
      </ol>
      {% else %}
      <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu v·ªÅ s·∫£n ph·∫©m.</p>
      {% endif %}

    </div>
  </div>
  <footer class="text-center mt-5 py-4">
  <p>&copy;¬©2025 NAM Cohhee. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
  <p> Contact: 0974644276 </p>
  <div class="social-links mt-2">
    <a href="https://www.facebook.com/share/1B1Y4CbxdF/" target="_blank" class="mx-2 text-dark">
      <i class="fab fa-facebook fa-lg"></i>
    </a>
    <a href="https://www.instagram.com/nampham9665?igsh=ZGFtcmdncTE4cWh1" target="_blank" class="mx-2 text-dark">
      <i class="fab fa-instagram fa-lg"></i>
    </a>
  </div>
</footer>
  <script>
  document.getElementById('avatar-input').addEventListener('change', function() {
    if(this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('avatar-img').src = e.target.result;
      }
      reader.readAsDataURL(this.files[0]);
      const formData = new FormData();
      formData.append('avatar', this.files[0]);

      fetch('{{ url_for("update_avatar") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message); 
      })
      .catch(err => alert('L·ªói upload avatar!'));
    }
  });

const editBtn = document.getElementById('edit-info-btn');
let editing = false;

editBtn.addEventListener('click', () => {
  const usernameSpan = document.getElementById('username-text');
  const phoneSpan = document.getElementById('phone-text');
  const addressSpan = document.getElementById('address-text');

  if(!editing){
    const usernameInput = document.createElement('input');
    usernameInput.id = 'username-input';
    usernameInput.value = usernameSpan.textContent;
    usernameInput.className = 'form-control form-control-sm mb-1';
    usernameSpan.replaceWith(usernameInput);

    const phoneInput = document.createElement('input');
    phoneInput.id = 'phone-input';
    phoneInput.value = phoneSpan.textContent;
    phoneInput.className = 'form-control form-control-sm mb-1';
    phoneSpan.replaceWith(phoneInput);

    const addressInput = document.createElement('input');
    addressInput.id = 'address-input';
    addressInput.value = addressSpan.textContent;
    addressInput.className = 'form-control form-control-sm mb-1';
    addressSpan.replaceWith(addressInput);

    editBtn.textContent = 'üíæ L∆∞u th√¥ng tin';
    editing = true;
  } else {
    const newUsername = document.getElementById('username-input').value.trim();
    const newPhone = document.getElementById('phone-input').value.trim();
    const newAddress = document.getElementById('address-input').value.trim();
    console.log({ newUsername, newPhone, newAddress });

    fetch('{{ url_for("update_user_info") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({username: newUsername, phone: newPhone, address: newAddress})
    })
    .then(res => res.json())
    .then(data => {
      if(data.success){
        const usernameSpanNew = document.createElement('span');
        usernameSpanNew.id = 'username-text';
        usernameSpanNew.textContent = newUsername;
        document.getElementById('username-input').replaceWith(usernameSpanNew);

        const phoneSpanNew = document.createElement('span');
        phoneSpanNew.id = 'phone-text';
        phoneSpanNew.textContent = newPhone;
        document.getElementById('phone-input').replaceWith(phoneSpanNew);

        const addressSpanNew = document.createElement('span');
        addressSpanNew.id = 'address-text';
        addressSpanNew.textContent = newAddress;
        document.getElementById('address-input').replaceWith(addressSpanNew);

        editBtn.textContent = '‚úèÔ∏è S·ª≠a th√¥ng tin';
        editing = false;
        alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
      } else {
        alert('C·∫≠p nh·∫≠t th·∫•t b·∫°i: ' + data.message);
      }
    })
    .catch(err => alert('L·ªói server!'));
  }
});

</script>
</body>
</html>
